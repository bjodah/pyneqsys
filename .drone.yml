pipeline:
  build:
    image: bjodah/bjodahimg20dot:21.7.m
    environment:
      - PYNLEQ2_NLEQ2_ROOT_URL:
          from_secret: nleq2_root_url
      commands:
        - (cd /; python3 -m pip install --user pynleq2)
        - export PYNLEQ2_NLEQ2_ROOT_URL=""
        - ./scripts/ci.sh pyneqsys
        - ./scripts/prepare_deploy.sh

  deploy:
    image: drillster/drone-rsync
    when:
      event: [push]
    hosts: [ "sayyy.mooo.com" ]
    port: 40022
    user: pyneqsys
    secrets: [ rsync_key ]  # secret only set from event "push" not "pull_request"
    source: ./deploy/public_html/branches/.
    target: ~/public_html/branches/
